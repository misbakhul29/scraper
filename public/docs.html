<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scraper API Documentation</title>
  <link 
  rel="icon" 
  href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='20' y='35' width='60' height='50' rx='12' fill='%233b82f6'/><path d='M50 35 L50 15' stroke='%233b82f6' stroke-width='6'/><circle cx='50' cy='15' r='6' fill='%23ef4444'/><circle cx='40' cy='55' r='6' fill='white'/><circle cx='60' cy='55' r='6' fill='white'/></svg>" 
/>
  <style>
    body { font-family: Inter, Roboto, system-ui, Arial, sans-serif; line-height: 1.6; background:#f7fafc; color:#0f172a; padding:32px; }
    .container { max-width:960px; margin:0 auto; background:#fff; padding:24px; border-radius:8px; box-shadow:0 8px 24px rgba(15,23,42,0.06); }
    h1 { margin-top:0; }
    pre { background:#0f172a; color:#f8fafc; padding:12px; border-radius:6px; overflow:auto }
    code { padding:2px 6px; border-radius:4px }
    dl dt { font-weight:600; margin-top:16px }
    .badge { display:inline-block; background:#e6f7ff; color:#0369a1; padding:6px 8px; border-radius:6px; font-size:13px }
    .note { background:#fff7ed; border-left:4px solid #fb923c; padding:8px 12px; margin:12px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Scraper API Documentation</h1>
    <p class="badge">Payload limit: 100kb • Generation rate limit: 5 req / 60s</p>

    <section>
      <h2>Overview</h2>
      <p>This service queues article generation jobs and processes them using a ChatGPT-based scraper.</p>
      <p>Responses are JSON and incoming payloads are sanitized to remove scripts and dangerous HTML fragments.</p>
    </section>

    <section>
      <h2>Endpoints</h2>

      <h3>POST /api/articles/generate</h3>
      <p>Public endpoint that queues generation and optionally notifies your webhook when done.</p>
      <pre><code>curl -X POST http://localhost:3000/api/articles/generate \
  -H "Content-Type: application/json" \
  -d '{"topic":"My topic","webhookUrl":"https://example.com/webhook","webhookSecret":"s3cr3t"}'</code></pre>
      <p><strong>Webhook delivery:</strong> When you include <code>webhookUrl</code> (and optionally <code>webhookSecret</code>) in your generation request, the service will enqueue the job and POST the result to your webhook URL when the job completes.</p>
      <p>The POST uses <code>Content-Type: application/json</code> and the body will be one of the following shapes:</p>
      <pre><code>// Success
{
  "success": true,
  "jobId": "article-169704...",
  "data": { /* article object (id, title, content, wordCount, etc.) */ }
}

// Failure
{
  "success": false,
  "jobId": "article-169704...",
  "error": "Error message"
}
</code></pre>
      <p>Headers set by the service:</p>
      <ul>
        <li><code>X-Webhook-Type</code>: <code>article</code> (or <code>novel</code> for novel jobs)</li>
        <li><code>X-Webhook-Signature</code> (optional): HMAC-SHA256 hex digest of the JSON body using the <code>webhookSecret</code> you provided when queuing the job. Example (bash):</li>
      </ul>
      <pre><code># compute signature for body
sig=$(echo -n '{"jobId":"..."}' | openssl dgst -sha256 -hmac "s3cr3t" | sed 's/^.*= //')
# set header: X-Webhook-Signature: $sig
</code></pre>
      <p><strong>Acknowledgement:</strong> Return any 2xx HTTP status to acknowledge the webhook; non-2xx responses are logged and do not cause the generation job to be retried automatically.</p>
      <h3>POST /api/webhook/test</h3>
      <p><strong>Development-only:</strong> This test endpoint is provided only for local development and testing and is <strong>not exposed in production</strong>. It accepts webhook POSTs and stores them to <code>/logs/webhooks/*.json</code>. If you provide a secret (either as query <code>?secret=...</code> or header <code>X-Webhook-Secret</code>), the endpoint will verify the <code>X-Webhook-Signature</code> header (HMAC-SHA256 hex of the JSON body) and return whether the signature matched.</p>
      <pre><code>curl -X POST http://localhost:3000/api/webhook/test \
  -H "Content-Type: application/json" \
  -H "X-Webhook-Secret: s3cr3t" \
  -H "X-Webhook-Signature: $(echo -n '{"jobId":"1"}' | openssl dgst -sha256 -hmac "s3cr3t" | sed 's/^.*= //')" \
  -d '{"jobId":"1","result":"ok"}'</code></pre>

      <h3>Webhook requirements for clients</h3>
      <p>If you are receiving webhooks from this service, implement the following simple rules to ensure compatibility and security:</p>
      <ul>
        <li>Accept <code>POST</code> with <code>Content-Type: application/json</code>.</li>
        <li>Return any <code>2xx</code> HTTP status to acknowledge receipt (the service logs non-2xx responses).</li>
        <li>If you supplied <code>webhookSecret</code> when queuing the job, verify the header <code>X-Webhook-Signature</code> (hex HMAC-SHA256 of the exact request body using that secret).</li>
        <li>Optionally inspect <code>X-Webhook-Type</code> to know whether the payload is an <code>article</code> or <code>novel</code>.</li>
        <li>Payload examples:
          <pre><code>// Article success
{ "success": true, "jobId": "article-...", "data": { /* article */ } }

// Novel success
{ "success": true, "jobId": "novel-...", "data": { "title": "...", "language":"...","wordCount": 1234, "content": "..." } }

// Failure
{ "success": false, "jobId": "...", "error": "..." }
</code></pre>
        </li>
      </ul>

      <h3>POST /api/novels/generate</h3>
      <p>Public endpoint that queues novel generation jobs and optionally notifies your webhook when done. Example body fields: <code>{ "title", "language", "genre", "approxWords", "prompt", "sessionName", "webhookUrl", "webhookSecret" }</code>. Rate-limited to ~2 requests / 60s.</p>
      <pre><code>curl -X POST http://localhost:3000/api/novels/generate \
  -H "Content-Type: application/json" \
  -d '{"title":"The Lost Island","language":"Indonesian","genre":"Adventure","approxWords":5000, "webhookUrl":"https://example.com/webhook","webhookSecret":"s3cr3t"}'</code></pre>
      <h3>GET /api/articles/queue/status</h3>
      <p>Queue status (messageCount, consumerCount).</p>
    </section>

    <section>
      <h2>Security Notes</h2>
      <div class="note">
        <strong>Sanitization:</strong> All incoming string fields are sanitized to remove obvious XSS vectors (scripts, inline event handlers, javascript: URIs).
      </div>
    </section>

    <section>
      <h2>IP Whitelist & Blacklist</h2>
      <p>The public generation endpoint <code>/api/articles/generate-public</code> is protected by an IP access control list.</p>
      <ul>
        <li><strong>POST /api/ip/request</strong> — Request whitelist for your IP. Body: <code>{ ip?: string, note?: string }</code>. If <code>ip</code> is omitted, your request IP will be used. New requests are created with status <code>PENDING</code> (waiting approval).</li>
        <li><strong>GET /api/ip</strong> — Admin: list IP requests (requires <code>X-Admin-Key</code> header set to <code>ADMIN_API_KEY</code>).</li>
        <li><strong>PATCH /api/ip/:id/status</strong> — Admin: update IP status to <code>PENDING</code>/<code>WHITELIST</code>/<code>BLACKLIST</code> (requires <code>X-Admin-Key</code>).</li>
      </ul>
      <p>Behavior when hitting protected routes:</p>
      <ul>
        <li><strong>WHITELIST</strong> — Request proceeds normally.</li>
        <li><strong>PENDING</strong> — Returns <code>403</code> with message <em>Your IP is waiting approval</em> (or asks to POST /api/ip/request if no record exists).</li>
        <li><strong>BLACKLIST</strong> — Returns <code>403</code> with a friendly quote ("kata-kata mutiara").</li>
      </ul>
      <p>Postman collection for testing: <a href="/public/postman/Scraper.postman_collection.json">Download collection JSON</a> and import into Postman. Use the included environment <code>Scraper Local</code> (file: <code>Scraper.environment.json</code>).</p>
    </section>

    <section>
        <h2>Support</h2>
        <p>Jika ada pertanyaan mengenai scraper, silakan kirim email ke: <a href="mailto:misbakhul2904@gmail.com">misbakhul2904@gmail.com</a> atau lewat Facebook: <a href="https://www.facebook.com/Misbakhul29" target="_blank" rel="noopener noreferrer">facebook.com/Misbakhul29</a></p>
    </section>

    <footer style="margin-top:20px; font-size:13px; color:#64748b">
      <div>Generated by Scraper</div>
    </footer>
  </div>
</body>
</html>