name: Deploy to VPS (PM2)

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to VPS with PM2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Create .env file from secrets
        run: |
          mkdir -p deploy-package
          echo "${{ secrets.ENV_FILE }}" > deploy-package/.env
          echo "âœ… .env file created from ENV_FILE secret"    

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate

      - name: Build TypeScript
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp -r src/generated deploy-package/src/ 2>/dev/null || true
          cp package*.json deploy-package/
          cp tsconfig.json deploy-package/
          cp prisma deploy-package/ -r
          # Copy session files if they exist (optional)
          mkdir -p deploy-package/sessions
          cp sessions/*.bin deploy-package/sessions/ 2>/dev/null || true
          tar -czf deploy-package.tar.gz deploy-package/

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "deploy-package.tar.gz"
          target: "/tmp"

      - name: Deploy and Restart on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e
            
            APP_DIR="${{ secrets.VPS_APP_DIR || '/opt/scraper' }}"
            BACKUP_DIR="$APP_DIR/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "ðŸš€ Starting deployment..."
            
            # Create directories
            mkdir -p $APP_DIR
            mkdir -p $BACKUP_DIR
            mkdir -p $APP_DIR/logs
            mkdir -p $APP_DIR/articles
            mkdir -p $APP_DIR/sessions
            
            # Backup current deployment
            if [ -d "$APP_DIR/dist" ]; then
              echo "ðŸ“¦ Creating backup..."
              tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C $APP_DIR dist src/generated package*.json 2>/dev/null || true
              # Keep only last 5 backups
              ls -t $BACKUP_DIR/backup_*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null || true
            fi
            
            # Extract deployment
            echo "ðŸ“‚ Extracting deployment package..."
            cd /tmp
            tar -xzf deploy-package.tar.gz
            
            # Stop PM2 process
            echo "â¸ï¸ Stopping PM2 process..."
            pm2 stop scraper || true
            pm2 delete scraper || true
            
            # Copy files (but preserve existing .env if it exists)
            echo "ðŸ“‹ Copying files..."
            if [ -f "$APP_DIR/.env" ]; then
              echo "âœ… Preserving existing .env file"
              cp $APP_DIR/.env $APP_DIR/.env.backup
            fi
            cp -r deploy-package/* $APP_DIR/
            
            # Restore .env backup if deployment didn't include one, or use the new one
            if [ -f "$APP_DIR/.env.backup" ] && [ ! -f "deploy-package/.env" ]; then
              echo "ðŸ“‹ Restoring .env from backup"
              mv $APP_DIR/.env.backup $APP_DIR/.env
            elif [ -f "$APP_DIR/.env.backup" ]; then
              echo "ðŸ“‹ Using new .env file from deployment"
              rm $APP_DIR/.env.backup
            fi
            
            # Ensure .env file exists and has correct permissions
            if [ -f "$APP_DIR/.env" ]; then
              echo "âœ… .env file configured"
              chmod 600 $APP_DIR/.env
            else
              echo "âš ï¸ .env file not found, creating from template..."
              cat > $APP_DIR/.env << 'EOF'
            NODE_ENV=production
            PORT=3000
            DATABASE_URL=postgresql://user:password@localhost:5432/chatgpt_scraper?schema=public
            CHROME_DEBUG_PORT=9222
            CHROME_USER_DATA_DIR=/opt/scraper/chrome-data
            RABBITMQ_HOST=localhost
            RABBITMQ_PORT=5672
            RABBITMQ_USER=guest
            RABBITMQ_PASSWORD=guest
            DEFAULT_SESSION=default
            EOF
              chmod 600 $APP_DIR/.env
              echo "âš ï¸ Please update .env file with correct values!"
            fi
            
            # Install dependencies
            echo "ðŸ“¦ Installing dependencies..."
            cd $APP_DIR
            npm ci --production
            
            # Generate Prisma client
            echo "ðŸ—„ï¸ Generating Prisma client..."
            npm run prisma:generate || true
            
            # Run migrations
            echo "ðŸ—„ï¸ Running database migrations..."
            npm run prisma:migrate deploy || echo "âš ï¸ Migration failed, continuing..."
            
            # Cleanup
            rm -rf /tmp/deploy-package /tmp/deploy-package.tar.gz
            
            # Start with PM2
            echo "ðŸ”„ Starting application with PM2..."
            cd $APP_DIR
            pm2 start dist/index.js \
              --name scraper \
              --update-env \
              --log-date-format "YYYY-MM-DD HH:mm:ss Z" \
              --merge-logs \
              --log $APP_DIR/logs/app.log \
              --error $APP_DIR/logs/error.log \
              --out $APP_DIR/logs/out.log
            
            # Save PM2 configuration
            pm2 save || true
            
            # Show status
            pm2 status scraper
            pm2 logs scraper --lines 20 --nostream
            
            echo "âœ… Deployment completed successfully!"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            sleep 10
            echo "ðŸ” Checking application status..."
            pm2 status scraper
            pm2 logs scraper --lines 10 --nostream
            
            if [ -n "${{ secrets.VPS_APP_URL }}" ]; then
              echo "ðŸ” Checking health endpoint..."
              curl -f ${{ secrets.VPS_APP_URL }}/health && echo "âœ… Health check passed" || echo "âš ï¸ Health check failed"
            fi

