name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npm run prisma:generate

      - name: Build TypeScript
        run: npm run build

      - name: Create deployment package
        run: |
          mkdir -p deploy-package
          cp -r dist deploy-package/
          cp -r src/generated deploy-package/src/ 2>/dev/null || true
          cp package*.json deploy-package/
          cp tsconfig.json deploy-package/
          cp prisma deploy-package/ -r
          cp .env.example deploy-package/ 2>/dev/null || true
          tar -czf deploy-package.tar.gz deploy-package/

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          source: "deploy-package.tar.gz"
          target: "/tmp"

      - name: Extract and Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e
            
            # Variables
            APP_DIR="${{ secrets.VPS_APP_DIR || '/opt/scraper' }}"
            BACKUP_DIR="$APP_DIR/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            echo "üöÄ Starting deployment..."
            
            # Create app directory if it doesn't exist
            sudo mkdir -p $APP_DIR
            sudo mkdir -p $BACKUP_DIR
            
            # Backup current deployment
            if [ -d "$APP_DIR/dist" ]; then
              echo "üì¶ Creating backup..."
              sudo tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" -C $APP_DIR dist src/generated package*.json 2>/dev/null || true
            fi
            
            # Extract new deployment
            echo "üìÇ Extracting deployment package..."
            cd /tmp
            tar -xzf deploy-package.tar.gz
            
            # Stop application (if running with PM2)
            if command -v pm2 &> /dev/null; then
              echo "‚è∏Ô∏è Stopping application..."
              pm2 stop scraper || true
              pm2 delete scraper || true
            fi
            
            # Stop application (if running with systemd)
            if systemctl is-active --quiet scraper.service 2>/dev/null; then
              echo "‚è∏Ô∏è Stopping systemd service..."
              sudo systemctl stop scraper.service || true
            fi
            
            # Copy files to app directory
            echo "üìã Copying files..."
            sudo cp -r deploy-package/* $APP_DIR/
            sudo chown -R ${{ secrets.VPS_USER }}:${{ secrets.VPS_USER }} $APP_DIR
            
            # Install production dependencies
            echo "üì¶ Installing dependencies..."
            cd $APP_DIR
            npm ci --production
            
            # Run Prisma migrations
            echo "üóÑÔ∏è Running database migrations..."
            npm run prisma:generate || true
            npm run prisma:migrate deploy || echo "‚ö†Ô∏è Migration failed, continuing..."
            
            # Cleanup
            rm -rf /tmp/deploy-package /tmp/deploy-package.tar.gz
            
            # Restart application with PM2
            if command -v pm2 &> /dev/null; then
              echo "üîÑ Starting application with PM2..."
              cd $APP_DIR
              pm2 start dist/index.js --name scraper --update-env
              pm2 save || true
            else
              # Restart application with systemd
              if [ -f /etc/systemd/system/scraper.service ]; then
                echo "üîÑ Starting systemd service..."
                sudo systemctl daemon-reload
                sudo systemctl enable scraper.service
                sudo systemctl start scraper.service
              else
                echo "‚ö†Ô∏è No process manager found. Please start the application manually."
              fi
            fi
            
            echo "‚úÖ Deployment completed successfully!"

      - name: Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            sleep 5
            if command -v pm2 &> /dev/null; then
              pm2 status scraper
            elif systemctl is-active --quiet scraper.service 2>/dev/null; then
              sudo systemctl status scraper.service --no-pager -l
            fi
            
            # Check if application is responding
            if [ -n "${{ secrets.VPS_APP_URL }}" ]; then
              echo "üîç Checking application health..."
              curl -f ${{ secrets.VPS_APP_URL }}/health || echo "‚ö†Ô∏è Health check failed"
            fi

